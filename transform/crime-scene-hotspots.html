<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .node {
        cursor: pointer;
    }

    .node:hover {
        stroke: #000;
        stroke-width: 1.5px;
    }

    .node--root {
        stroke: #777;
        stroke-width: 2px;
    }

    .node--leaf {
        fill: white;
        stroke: #777;
        stroke-width: 1px;
    }

    .label {
        font: 14px "Helvetica Neue", Helvetica, Arial, sans-serif;
        text-anchor: middle;
        fill: white;
        fill-opacity: 1;
        text-shadow: 0 1px 0 #000, 1px 0 0 #000, -1px 0 0 #000, 0 -1px 0 #000;
        transition: fill-opacity ease-in-out 0.2s;
    }

    .label.ignore {
        fill-opacity: 0;
    }

    .label,
    .node--root {
        pointer-events: none;
    }

</style>
<body>
<script src="d3/d3.min.js"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const searchLocation = urlParams.get('source');

    var margin = 10,
        outerDiameter = 960,
        innerDiameter = outerDiameter - margin - margin;

    var x = d3.scale.linear()
        .range([0, innerDiameter]);

    var y = d3.scale.linear()
        .range([0, innerDiameter]);

    var color = d3.scale.linear()
        .domain([-1, 5])
        .range(["hsl(185,60%,99%)", "hsl(187,40%,70%)"])
        .interpolate(d3.interpolateHcl);

    var pack = d3.layout.pack()
        .padding(2)
        .size([innerDiameter, innerDiameter])
        .value(function(d) { return d.size; })

    var svg = d3.select("body").append("svg")
        .attr("width", outerDiameter)
        .attr("height", outerDiameter)
        .append("g")
        .attr("transform", "translate(" + margin + "," + margin + ")");

    d3.json("hotspots.json", function(error, root) {
        var focus = root,
            nodes = pack.nodes(root);

        svg.append("g").selectAll("circle")
            .data(nodes)
            .enter().append("circle")
            .attr("class", function(d) { return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root"; })
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
            .attr("r", function(d) { return d.r; })
            .style("fill", function(d) { return d.weight > 0.0 ? "darkred" :
                d.children ? color(d.depth) : "WhiteSmoke"; })
            .style("fill-opacity", function(d) { return d.weight; })
            .on("click", function(d) { return d.children ? zoom(d) : view(d) });

        svg.append("g").selectAll("text")
            .data(nodes)
            .enter().append("text")
            .attr("class", function(d) { return hideLabel(d) ? 'label ignore' : 'label'})
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
            .style("display", function(d) { return d.parent === root ? null : "none"; })
            .text(function(d) { return d.name; });

        d3.select(window)
            .on("click", function() { zoom(root); });

        function view(d) {
            if (!searchLocation) {
              return;
            }

            d3.event.stopPropagation();
            var segments = [];
            while(!!d.parent) {
              segments.unshift(d.name);
              d = d.parent;
            }
            window.open(searchLocation + segments.join('/'), '_blank').focus();
        }

        function hideLabel(node) {
          var manySiblings = node.parent && node.parent.children.length > 25;
          return manySiblings && notInteresting(node);
        }

        function notInteresting(node) {
          return (node.weight === undefined && node.value < 200) || node.weight < 0.1;
        }

        function zoom(d, i) {
            var focus0 = focus;
            focus = d;

            var k = innerDiameter / d.r / 2;
            x.domain([d.x - d.r, d.x + d.r]);
            y.domain([d.y - d.r, d.y + d.r]);
            d3.event.stopPropagation();

            var transition = d3.selectAll("text,circle").transition()
                .duration(d3.event.altKey ? 7500 : 750)
                .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });

            transition.filter("circle")
                .attr("r", function(d) { return k * d.r; });

            transition.filter("text")
                .filter(function(d) { return d.parent === focus || d.parent === focus0; })
                .each("start", function(d) { if (d.parent === focus) this.style.display = "inline"; })
                .each("end", function(d) { if (d.parent !== focus) this.style.display = "none"; });
        }}
    );

    d3.select(self.frameElement).style("height", outerDiameter + "px");

</script>
